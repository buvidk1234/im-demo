<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.it.imdemo.infrastructure.persistence.mapper.MessageMapper">

    <resultMap id="BaseResultMap" type="com.it.imdemo.infrastructure.persistence.entity.MessageEntity">
            <id property="id" column="id" />
            <result property="conversationId" column="conversation_id" />
            <result property="senderId" column="sender_id" />
            <result property="receiverId" column="receiver_id" />
            <result property="messageType" column="message_type" />
            <result property="content" column="content" />
            <result property="deliveredAt" column="delivered_at" />
            <result property="readAt" column="read_at" />
            <result property="createdAt" column="created_at" />
    </resultMap>

    <sql id="Base_Column_List">
        id,conversation_id,sender_id,receiver_id,message_type,content,
        delivered_at,read_at,created_at
    </sql>
    <select id="findUnreadMessagesByUserId" resultType="com.it.imdemo.domain.message.model.Message">
        SELECT m.id       AS message_id,
               m.conversation_id,
               m.sender_id,
               m.content,
               m.created_at,
               c.type = 1 AS is_group
        FROM messages m
                 JOIN conversations c ON m.conversation_id = c.id
                 LEFT JOIN read_receipts r ON m.id = r.message_id AND r.user_id = #{userId}
        WHERE (c.type = 0 AND m.receiver_id = #{userId} AND m.read_at IS NULL)
           OR (c.type = 1 AND r.user_id IS NOT NULL AND r.read_at IS NULL)
        ORDER BY m.created_at;
    </select>
</mapper>
